一 **背景**     
========  
&ensp;&ensp;&ensp;&ensp;与走完isp或走部分isp的rgb格式图像不同，相机直出的RAW Bayer格式的图像的噪声具有规律性，可以较为精确的用特定的数学模型进行建模，然后利用参数估计的方式求出具体成像设备的噪声模型参数。这应该就是相机直出raw bayer格式图像降噪效果（尤其在信噪比高的暗部区域）相对rgb图像上降噪效果好的最主要原因。因为知道了一张图像上各个位置的噪声强度，能够对图像各个区域进行自适应的降噪，这样特定区域不至于过降噪或者少降噪，相对与rgb图像处理无规律的噪声，不用在牺牲细节的基础上实现噪声的去除。  

二 **噪声模型**    
========
&ensp;&ensp;&ensp;&ensp;相机成像所成的噪声是信号相关的,考虑信号相关噪声的一般形式:  
$$z(x) = y(x) + \sigma({y(x)})\xi(x),x\in{X}$$

$$\xi(x)\sim{N(0, 1)}$$

&ensp;&ensp;&ensp;&ensp;其中:$x$表示所在图像坐标，$y(x)$属于真实信号，$z(x)$属于相机最终观测到的信号,$\sigma()$表征噪声的标准差。我们将曝光时间内光子打在相机sensor上这个过程的不确定性建模为泊松分布，产生的噪声称泊松噪声项;将热噪声，读取噪声等剩余影响较小的噪声建模为高斯分布。  
$$\sigma({y(x)})\xi(x)=\eta_p(y(x))+\eta_g(x)$$  

&ensp;&ensp;&ensp;&ensp;$\eta_p$是泊松项噪声，与信号强度$y(x)$相关，$\eta_g$是高斯项噪声。泊松分布特性：期望等于方差，且泊松分布在某个确定期望值下的分布近似于高斯分布：$P(\lambda)\approx{N(\lambda, \lambda)}$。由于相机成像量子效率泊松分布是放缩的,即$P(\lambda)\approx{N(\lambda, a\lambda)}$。高斯项噪声：$\eta_g(x)\sim{N(0, b)}$。
$$
\left \{ 
\begin{array}{c}
&\text{Poissonian: }var(\eta_p(y(x)))=ay(x) \\ 
&\text{Gaussian:  }var(\eta_g(x))=b
\end{array}
\right.
$$

&ensp;&ensp;&ensp;&ensp;因为产生泊松过程的噪声与高斯过程的噪声是相互独立的，所以相机最终观测得到的噪声方差与标准差为：
$$\sigma^2({y(x)})＝ay(x)+b$$

$$\sigma({y(x)})＝\sqrt{ay(x)+b}$$

&ensp;&ensp;&ensp;&ensp;其中$a$和$b$就是我们需要标定的参数。

三 **标定实验流程**      
========
1单帧标定实验流程     
------------  
&ensp;&ensp;&ensp;&ensp;通过单帧raw图像数据标定噪声相对多帧raw数据困难。联合泊松项与高斯项一起进行参数估计，因为高斯项相对泊松项影响较小，所以联合参数估计得到的高斯项参数$b$会有较大的误差，为了解决这个问题，我们将高斯项噪声与泊松噪声分开标定。
&ensp;&ensp;&ensp;&ensp;实验表明，所成图像的噪声主要与相机拍摄时设置的模拟增益有关(数字增益的本质是直接乘上一个系数，其影响暂时不谈)，环境色温，曝光时间，环境温度的影响基本忽略不计。我们通过设定不同的iso，拍摄拍摄灰阶图卡。灰阶图卡因为灰度值范围比较广，且每个图块里面的灰度值都均匀，方便计算方差。主要标定的原理简单的来说就是通过获取大量的信号值与噪声方差对，通过极大似然法来对噪声模型参数进行参数估计,得到当前相机setting(iso)下，所成图像的噪声模型参数。然后设定不同的iso,对每个iso条件下的噪声模型参数进行估计。最后得到当前成像设备的iso与噪声模型参数之间的关系。这样标定结束后，我们可以对通过相机拍摄图像时候的iso，计算所成图像具有怎样的噪声强度。

(1)泊松噪声标定    
_______________   
&ensp;&ensp;&ensp;&ensp;以j17(最大的模拟增益为16000)为例，分别以不同的iso[$80*2$, $100*2$, $200*2$, $400*2$, $600*2$, $800*2$, $1000*2$, $1200*2$, $1600*2$, $2000*2$, $2400*2$, $2800*2$, $3200*2$, $4000*2$, $5000*2$, $6000*2$, $7000*2$, $8000*2$]拍摄灰阶图卡。拍摄的灰阶成片如图:
![enter image description here](https://github.com/npzl/Awesome-Denoise/blob/master/iso800_1608822641783_input_8000x3000_2.RGGB.jpg)
&ensp;&ensp;&ensp;&ensp;用[https://git.n.xiaomi.com/huangbin1/calibrate_noise](https://git.n.xiaomi.com/huangbin1/calibrate_noise)这个工程run拍摄得到的raw文件，将得到标定的拟合结果与当前setting下相机噪声模型参数值。这里虽然a值与b值都能得出，但是b值估计的不是很准确，所以我们舍弃，只用得到的a值。
插入拟合结果图：
&ensp;&ensp;&ensp;&ensp;然后根据不同iso得到的a值，用最小二乘法线性拟合iso与a值之间的关系参数。
$$a(iso)=a_{k1}*iso+a_{k2}$$
插入拟合结果图：

(2)高斯噪声标定    
_______________  
&ensp;&ensp;&ensp;&ensp;以j17(最大的模拟增益为16000)为例，分别以不同的iso[$80*2$, $100*2$, $200*2$, $400*2$, $600*2$, $800*2$, $1000*2$, $1200*2$, $1600*2$, $2000*2$, $2400*2$, $2800*2$, $3200*2$, $4000*2$, $5000*2$, $6000*2$, $7000*2$, $8000*2$]拍摄完全没有光线的环境，这样就不会受到泊松噪声的影响，专门标定高斯噪声，结果更加精确。
&ensp;&ensp;&ensp;&ensp;然后根据不同iso得到的b值，用最小二乘法二次拟合iso与b值之间的关系参数。
$$b(iso)=b_{k1}*iso^2+b_{k2}*iso+b_{k3}$$
插入拟合结果图：

&ensp;&ensp;&ensp;&ensp;

2多帧标定实验流程     
------------



四 **SOME TEST**     
======

五 **SOME ANALYSIS**   
======


六 **文献**
======




![avatar](/home/npzl/Downloads/11/iso800_1608822641783_input_8000x3000_2.RGGB.jpg)
<!--stackedit_data:
eyJoaXN0b3J5IjpbMTUxNjkwMzE2NSw5NzI4ODM4NTUsMTM2Nj
I2NTMxLDg4NzE3NDY0OCwtMTcwMzMwNzAwMV19
-->